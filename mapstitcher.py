import os.path
from nbt.nbt import NBTFile
from PIL import Image
from config import *

def main():

	# Read map files to sort by scale
	print("Reading map files...")
	mapfiles = []
	for i in range(0,5):
		mapfiles.append([])
	i = 0
	while os.path.isfile(inputDir + "map_" + str(i) + ".dat"):
		# read file
		nbt = NBTFile(inputDir + "map_" + str(i) + ".dat")
		data = nbt["data"]
		if int(data["dimension"].value) == 0:
			scale = data["scale"].value
			print("  Map " + str(i))
			mapfiles[scale].append(i)
		nbt = None
		i = i + 1

	# Process map files in order of scaling, and build image
	print("Processing map files into image...")
	imgwidth = xmax - xmin
	imgheight = zmax - zmin
	img = Image.new('RGBA', (imgwidth, imgheight))
	colormap = getcolormap()
	for s in reversed(range(0,5)):
		for i in mapfiles[s]:

			# get map info
			nbt = NBTFile(inputDir + "map_" + str(i) + ".dat")
			data = nbt["data"]
			scale = 2 ** int(data["scale"].value)
			cx = data["xCenter"].value - (64 * scale)
			cz = data["zCenter"].value - (64 * scale)
			print("  Map " + str(i) + ": Scale = " + str(scale) + ":1, Corner=" + str(cx) + "," + str(cz))

			# get colors
			for mx in range(0,128):
				for mz in range(0,128):
					# color at map pixel
					colorindex = data["colors"][mx + mz * 128]
					if colorindex < 4: # unexplored
						continue
					color = colormap[colorindex]
					# iterate over actual world blocks
					for px in range(0,scale):
						for pz in range(0,scale):
							coords = (cx + (mx * scale) + px, cz + (mz * scale) + pz)
							imgx = coords[0] - xmin
							imgy = coords[1] - zmin
							if imgx >= 0 and imgx < imgwidth and imgy >= 0 and imgy < imgheight:
								img.putpixel((imgx,imgy), color)

			# clean up
			nbt = None
			data = None

	print("Saving image...")
	img.save(outputFile)
	print("Done!")

def getcolormap():
	colormap = {}
	colormap[0] = (0, 0, 0)
	colormap[1] = (0, 0, 0)
	colormap[2] = (0, 0, 0)
	colormap[3] = (0, 0, 0)
	colormap[4] = (89, 125, 39)
	colormap[5] = (109, 153, 48)
	colormap[6] = (127, 178, 56)
	colormap[7] = (67, 94, 29)
	colormap[8] = (174, 164, 115)
	colormap[9] = (213, 201, 140)
	colormap[10] = (247, 233, 163)
	colormap[11] = (130, 123, 86)
	colormap[12] = (140, 140, 140)
	colormap[13] = (171, 171, 171)
	colormap[14] = (199, 199, 199)
	colormap[15] = (105, 105, 105)
	colormap[16] = (180, 0, 0)
	colormap[17] = (220, 0, 0)
	colormap[18] = (255, 0, 0)
	colormap[19] = (135, 0, 0)
	colormap[20] = (112, 112, 180)
	colormap[21] = (138, 138, 220)
	colormap[22] = (160, 160, 255)
	colormap[23] = (84, 84, 135)
	colormap[24] = (117, 117, 117)
	colormap[25] = (144, 144, 144)
	colormap[26] = (167, 167, 167)
	colormap[27] = (88, 88, 88)
	colormap[28] = (0, 87, 0)
	colormap[29] = (0, 106, 0)
	colormap[30] = (0, 124, 0)
	colormap[31] = (0, 65, 0)
	colormap[32] = (180, 180, 180)
	colormap[33] = (220, 220, 220)
	colormap[34] = (255, 255, 255)
	colormap[35] = (135, 135, 135)
	colormap[36] = (115, 118, 129)
	colormap[37] = (141, 144, 158)
	colormap[38] = (164, 168, 184)
	colormap[39] = (86, 88, 97)
	colormap[40] = (106, 76, 54)
	colormap[41] = (130, 94, 66)
	colormap[42] = (151, 109, 77)
	colormap[43] = (79, 57, 40)
	colormap[44] = (79, 79, 79)
	colormap[45] = (96, 96, 96)
	colormap[46] = (112, 112, 112)
	colormap[47] = (59, 59, 59)
	colormap[48] = (45, 45, 180)
	colormap[49] = (55, 55, 220)
	colormap[50] = (64, 64, 255)
	colormap[51] = (33, 33, 135)
	colormap[52] = (100, 84, 50)
	colormap[53] = (123, 102, 62)
	colormap[54] = (143, 119, 72)
	colormap[55] = (75, 63, 38)
	colormap[56] = (180, 177, 172)
	colormap[57] = (220, 217, 211)
	colormap[58] = (255, 252, 245)
	colormap[59] = (135, 133, 129)
	colormap[60] = (152, 89, 36)
	colormap[61] = (186, 109, 44)
	colormap[62] = (216, 127, 51)
	colormap[63] = (114, 67, 27)
	colormap[64] = (125, 53, 152)
	colormap[65] = (153, 65, 186)
	colormap[66] = (178, 76, 216)
	colormap[67] = (94, 40, 114)
	colormap[68] = (72, 108, 152)
	colormap[69] = (88, 132, 186)
	colormap[70] = (102, 153, 216)
	colormap[71] = (54, 81, 114)
	colormap[72] = (161, 161, 36)
	colormap[73] = (197, 197, 44)
	colormap[74] = (229, 229, 51)
	colormap[75] = (121, 121, 27)
	colormap[76] = (89, 144, 17)
	colormap[77] = (109, 176, 21)
	colormap[78] = (127, 204, 25)
	colormap[79] = (67, 108, 13)
	colormap[80] = (170, 89, 116)
	colormap[81] = (208, 109, 142)
	colormap[82] = (242, 127, 165)
	colormap[83] = (128, 67, 87)
	colormap[84] = (53, 53, 53)
	colormap[85] = (65, 65, 65)
	colormap[86] = (76, 76, 76)
	colormap[87] = (40, 40, 40)
	colormap[88] = (108, 108, 108)
	colormap[89] = (132, 132, 132)
	colormap[90] = (153, 153, 153)
	colormap[91] = (81, 81, 81)
	colormap[92] = (53, 89, 108)
	colormap[93] = (65, 109, 132)
	colormap[94] = (76, 127, 153)
	colormap[95] = (40, 67, 81)
	colormap[96] = (89, 44, 125)
	colormap[97] = (109, 54, 153)
	colormap[98] = (127, 63, 178)
	colormap[99] = (67, 33, 94)
	colormap[100] = (36, 53, 125)
	colormap[101] = (44, 65, 153)
	colormap[102] = (51, 76, 178)
	colormap[103] = (27, 40, 94)
	colormap[104] = (72, 53, 36)
	colormap[105] = (88, 65, 44)
	colormap[106] = (102, 76, 51)
	colormap[107] = (54, 40, 27)
	colormap[108] = (72, 89, 36)
	colormap[109] = (88, 109, 44)
	colormap[110] = (102, 127, 51)
	colormap[111] = (54, 67, 27)
	colormap[112] = (108, 36, 36)
	colormap[113] = (132, 44, 44)
	colormap[114] = (153, 51, 51)
	colormap[115] = (81, 27, 27)
	colormap[116] = (17, 17, 17)
	colormap[117] = (21, 21, 21)
	colormap[118] = (25, 25, 25)
	colormap[119] = (13, 13, 13)
	colormap[120] = (176, 168, 54)
	colormap[121] = (215, 205, 66)
	colormap[122] = (250, 238, 77)
	colormap[123] = (132, 126, 40)
	colormap[124] = (64, 154, 150)
	colormap[125] = (79, 188, 183)
	colormap[126] = (92, 219, 213)
	colormap[127] = (48, 115, 112)
	colormap[128] = (52, 90, 180)
	colormap[129] = (63, 110, 220)
	colormap[130] = (74, 128, 255)
	colormap[131] = (39, 67, 135)
	colormap[132] = (0, 153, 40)
	colormap[133] = (0, 187, 50)
	colormap[134] = (0, 217, 58)
	colormap[135] = (0, 114, 30)
	colormap[136] = (91, 60, 34)
	colormap[137] = (111, 74, 42)
	colormap[138] = (129, 86, 49)
	colormap[139] = (68, 45, 25)
	colormap[140] = (79, 1, 0)
	colormap[141] = (96, 1, 0)
	colormap[142] = (112, 2, 0)
	colormap[143] = (59, 1, 0)
	colormap[144] = (147, 124, 113)
	colormap[145] = (180, 152, 138)
	colormap[146] = (209, 177, 161)
	colormap[147] = (110, 93, 85)
	colormap[148] = (112, 57, 25)
	colormap[149] = (137, 70, 31)
	colormap[150] = (159, 82, 36)
	colormap[151] = (84, 43, 19)
	colormap[152] = (105, 61, 76)
	colormap[153] = (128, 75, 93)
	colormap[154] = (149, 87, 108)
	colormap[155] = (78, 46, 57)
	colormap[156] = (79, 76, 97)
	colormap[157] = (96, 93, 119)
	colormap[158] = (112, 108, 138)
	colormap[159] = (59, 57, 73)
	colormap[160] = (131, 93, 25)
	colormap[161] = (160, 114, 31)
	colormap[162] = (186, 133, 36)
	colormap[163] = (98, 70, 19)
	colormap[164] = (72, 82, 37)
	colormap[165] = (88, 100, 45)
	colormap[166] = (103, 117, 53)
	colormap[167] = (54, 61, 28)
	colormap[168] = (112, 54, 55)
	colormap[169] = (138, 66, 67)
	colormap[170] = (160, 77, 78)
	colormap[171] = (84, 40, 41)
	colormap[172] = (40, 28, 24)
	colormap[173] = (49, 35, 30)
	colormap[174] = (57, 41, 35)
	colormap[175] = (30, 21, 18)
	colormap[176] = (95, 75, 69)
	colormap[177] = (116, 92, 84)
	colormap[178] = (135, 107, 98)
	colormap[179] = (71, 56, 51)
	colormap[180] = (61, 64, 64)
	colormap[181] = (75, 79, 79)
	colormap[182] = (87, 92, 92)
	colormap[183] = (46, 48, 48)
	colormap[184] = (86, 51, 62)
	colormap[185] = (105, 62, 75)
	colormap[186] = (122, 73, 88)
	colormap[187] = (64, 38, 46)
	colormap[188] = (53, 43, 64)
	colormap[189] = (65, 53, 79)
	colormap[190] = (76, 62, 92)
	colormap[191] = (40, 32, 48)
	colormap[192] = (53, 35, 24)
	colormap[193] = (65, 43, 30)
	colormap[194] = (76, 50, 35)
	colormap[195] = (40, 26, 18)
	colormap[196] = (53, 57, 29)
	colormap[197] = (65, 70, 36)
	colormap[198] = (76, 82, 42)
	colormap[199] = (40, 43, 22)
	colormap[200] = (100, 42, 32)
	colormap[201] = (122, 51, 39)
	colormap[202] = (142, 60, 46)
	colormap[203] = (75, 31, 24)
	colormap[204] = (26, 15, 11)
	colormap[205] = (31, 18, 13)
	colormap[206] = (37, 22, 16)
	colormap[207] = (19, 11, 8)
	return colormap

main()
